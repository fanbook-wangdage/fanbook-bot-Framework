print("""⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⣿⠛⠛⠃⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⠄⠄⠄⠄⠄⠄⠄⡟⠛⠛⣦⠄⢀⡴⠛⠛⠛⢦⡀⠘⠛⣿⠛⠛⠄⠄⠄⠤⢼⠤⢸⢉⣉⣉⣉⡁⠒⢺⠓⢲⠂⡟⠉⢹⠄⠄⠄
⠄⠄⣿⣤⣤⠄⠐⠉⠉⢳⠄⢸⡗⠉⠙⡆⠄⣿⠎⠉⢳⡆⠄⡖⠉⠉⢶⡄⢠⠞⠉⠉⣶⠄⢸⢀⡴⠋⠄⠄⠄⠄⣷⣤⣶⡃⠄⣾⡇⠄⠄⠄⠈⡇⠄⠄⣿⠄⠄⠄⠄⠄⢀⣾⢦⣸⢀⣀⣯⣀⠄⣠⠎⠤⠾⠄⠗⠒⠺⠄⠄⠄
⠄⠄⣿⠄⠄⠄⢸⠋⠉⣸⠄⢸⡇⠄⠄⡇⠄⣿⡀⠄⣠⡇⠄⣇⠄⠄⣸⠇⠸⣀⠄⠄⡿⠄⢸⠙⢧⡀⠄⠄⠄⠄⡇⠄⠄⣸⠄⠹⣇⡀⠄⢀⣰⠃⠄⠄⣿⠄⠄⠄⠄⠄⠟⢸⠄⢸⠄⠄⠇⠄⠄⠒⠒⠒⡶⡷⢖⠒⠒⠒⠄⠄
⠄⠄⠛⠄⠄⠄⠘⠛⠋⠘⠄⠘⠃⠄⠄⠃⠄⠛⠙⠚⠋⠄⠄⠉⠛⠛⠁⠄⠄⠙⠓⠛⠁⠄⠘⠄⠈⠛⠄⠄⠄⠄⠛⠛⠛⠁⠄⠄⠈⠛⠛⠋⠁⠄⠄⠄⠛⠄⠄⠄⠄⠄⠄⢸⠄⠸⠤⠤⠤⠤⠤⠤⠔⠋⠄⡇⠄⠛⠢⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⡆⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠰⠶⠶⢶⡶⠶⠶⠶⠄⠄⠄⠄⢸⡇⠄⠄⠄⠄⠒⠒⠒⠒⠒⠒⢲⠒⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⣇⠴⠶⣤⡀⢶⠄⠄⣰⠂⠄⠰⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⡇⠄⠄⠄⠄⠒⠒⠒⢺⡗⠒⠒⠒⠄⠄⠧⠤⠤⠼⠄⠸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⡇⠄⠄⢸⡇⠈⣆⢰⠏⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠉⠉⢹⡏⠉⠉⠁⠄⠄⠄⢀⡎⠹⡀⠄⠄⠄⢉⣉⣉⣉⣉⠉⢹⠉⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠟⠳⠶⠋⠄⠄⢸⡏⠄⠄⠄⠸⠄⠄⠄⠄⠄⠄⠄⣀⣀⣀⣸⣇⣀⣀⣀⠄⣀⠴⠋⠄⠄⠙⠧⣄⠄⠸⠷⠶⠶⠾⣀⣸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠤⠛⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠉⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄""")
import logging
import coloredlogs
# 创建日志记录器
logger = logging.getLogger(__name__)
# 配置 coloredlogs
coloredlogs.install(level='DEBUG', logger=logger)
_v=1.5
    
logger.info('版本号：'+str(_v))
logger.info("开始初始化")
from fanbookbotapi import *
import json
import requests
import os
import subprocess
import traceback
import sentry_sdk
import time
import sys
try:
    import win32api
except:
    pass    
from tqdm import tqdm

def main(runType='run'):
    try:
        sentry_sdk.init(
            dsn="https://b276d223ebdc092ad9d655d09403355d@o4507525750521856.ingest.us.sentry.io/4507924708982784",
            # Set traces_sample_rate to 1.0 to capture 100%
            # of transactions for tracing.
            traces_sample_rate=1.0,
            # Set profiles_sample_rate to 1.0 to profile 100%
            # of sampled transactions.
            # We recommend adjusting this value in production.
            profiles_sample_rate=1.0,
        )
        
        def update_install(name,url):
            a=0
            while a<10:
                try:
                    if appmsg[name]>file_v[name]:
                        file_name = url.split("/")[-1]
                        response = requests.get(url, stream=True)
                        file_size = int(response.headers.get("content-length", 0))
                        chunk_size = 1024  # 每次下载的块大小
                        start_time = time.time()
                        downloaded = 0
                        with open(file_name, "wb") as file, tqdm(
                            desc=file_name,
                            total=file_size,
                            unit="B",
                            unit_scale=True,
                            unit_divisor=1024,
                        ) as bar:
                            for data in response.iter_content(chunk_size=chunk_size):
                                file.write(data)
                                downloaded += len(data)
                                bar.update(len(data))
                                elapsed_time = time.time() - start_time
                                download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                                bar.set_postfix()
                        a=11
                        return True
                except:
                    logger.warning('下载失败，正在重试')
                    a+=1
                    
            if a==10:
                logger.warning('下载失败，请检查网络连接')
        
        logger.info('正在获取配置信息')
        
        try:
            appmsg=requests.get('https://124.221.67.43/hj_data.json')
            appmsg=appmsg.json()
        except:
            logger.warning('网络错误')
            
        logger.info('正在检查更新')
        try:
            #读取file_v.json
            try:
                with open('file_v.json', 'r', encoding='utf-8') as f:
                    file_v = json.load(f)
            except:
                file_v={'appmessage':0,'update':0,'ErrorUpload':0,'硬件检测引擎':0,"Settings":0}
                
            if appmsg['appmessage']>file_v['appmessage']:
                logger.info('发现新版本组件[消息通知工具]')
                if update_install('appmessage','https://124.221.67.43/appMessage.exe'):
                    file_v['appmessage']=appmsg['appmessage']

            if appmsg['update']>file_v['update']:
                logger.info('发现新版本组件[更新工具]')
                if update_install('update','https://124.221.67.43/hj_update.exe'):
                    file_v['update']=appmsg['update']

            if appmsg['ErrorUpload']>file_v['ErrorUpload']:
                logger.info('发现新版本组件[反馈工具]')
                if update_install('ErrorUpload','https://124.221.67.43/ErrorUpload.exe'):
                    file_v['ErrorUpload']=appmsg['ErrorUpload']

            if appmsg['硬件检测引擎']>file_v['硬件检测引擎']:
                logger.info('发现新版本组件[硬件信息获取工具]')
                if update_install('硬件检测引擎','https://124.221.67.43/硬件检测引擎.dll'):
                    file_v['硬件检测引擎']=appmsg['硬件检测引擎']

            if appmsg['Settings']>file_v['Settings']:
                logger.info('发现新版本组件[配置编辑器]')
                if update_install('Settings','https://124.221.67.43/Settings.exe'):
                    file_v['Settings']=appmsg['Settings']

            logger.info('更新完成')
            #更改file_v.json
            with open('file_v.json', 'w', encoding='utf-8') as f:
                json.dump(file_v, f, ensure_ascii=False, indent=4)

        except:
            logger.warning('更新错误')

        try:
            if appmsg['open']==True:
                subprocess.Popen(['appMessage.exe'])
        except:
            pass

        if _v<appmsg['main']:
            logger.info('发现新版本主程序')
            try:
                os.system('taskkill /f /im appMessage.exe')
                win32api.ShellExecute(0, 'open', 'hj_update.exe', '', '', 1)
                sys.exit()
            except:
                logger.warning('更新错误')

        # 检查plugin.json是否存在，如果不存在则创建
        if not os.path.exists('plugin.json'):
            with open('plugin.json', 'w', encoding='utf-8') as f:
                json.dump({"List": []}, f, ensure_ascii=False, indent=4)
        
        tempjson={
            "on_start" : "",
            "on_end_restart" : False,
            "on_error_restart" : False,
            "on_end_restart_time":5,
            "on_err_restart_time":5,
            "on_end_restart_log":"运行完成",
            "on_end_restart_out_to_file":False,
            "on_errror_log":True
        }
        
        # 检查Settings.json
        if not os.path.exists('Settings.json'):
            with open('Settings.json', 'w', encoding='utf-8') as f:
                json.dump(tempjson, f, ensure_ascii=False, indent=2)
        
        # 检查plugin文件夹是否存在，如果不存在则创建
        if not os.path.exists('plugin'):
            os.makedirs('plugin')
        
        def get_settings():
            with open('Settings.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        
        logger.info('初始化完成')

        # 用户输入代码文件路径，然后全局运行该文件
        def run_file(file_path,type='code'):
            #如果路径被双引号包围，则去掉双引号
            if file_path.startswith('"') and file_path.endswith('"'):
                file_path = file_path[1:-1]
            with open(file_path, 'r', encoding='utf-8') as f:
                code = f.read()
            if 'main.py' in file_path:
                logger.warning('程序目录下的main.py在每次更新后会被覆盖，请将代码保存到其他文件中')
            logger.info(f"正在运行文件：{file_path}")
            while True:
                exec(code)
                #读取Settings.json
                Settigs = get_settings()
                if Settigs['on_end_restart']==True and type=='code':
                    logger.info('程序结束，正在重启，可前往配置编辑器配置运行结束事件')
                    if Settigs['on_end_restart_out_to_file']==True:
                        #写入日志
                        with open('runLog.txt', 'a', encoding='utf-8') as f:
                            f.write(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())+'\n')
                            f.write(Settigs['on_end_restart_log']+'\n\n')
                    time.sleep(Settigs['on_end_restart_time'])
                else:
                    break
            logger.info(f"文件运行完成：{file_path}")
        
        # 读取Settings.json
        with open('Settings.json', 'r', encoding='utf-8') as f:
            Settigs = json.load(f)
        t='0'
        if Settigs['on_start']!='':
            while True:
                try:
                    logger.info('正在运行启动文件，可前往配置编辑器配置启动自动运行的文件')
                    run_file(Settigs['on_start'])
                except Exception as e:
                    # 获取详细的错误信息
                    error_info = traceback.format_exc()
                    logger.error(f"运行文件时发生错误：{error_info}")
                    # 读取Settings.json
                    Settigs = get_settings()
                    if Settigs['on_error_restart']==True:
                        logger.info('程序错误，正在重启，可前往配置编辑器配置错误处理项')
                        if Settigs['on_errror_log']==True:
                            #写入日志
                            with open('runLog.txt', 'a', encoding='utf-8') as f:
                                #写入时间
                                f.write(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())+'\n')
                                f.write('运行文件时出错\n'+error_info+'\n\n')
                        time.sleep(Settigs['on_err_restart_time'])
                        t='1'
                    else:
                        break

        while True:
            print("""1：运行文件
2：安装拓展
3：使用拓展
4：卸载拓展
F：发送反馈
S：打开配置编辑器
                """)
            if runType=='run':
                input_file_path = input("请输入功能编号：")
            else:
                input_file_path = '2'
            if input_file_path == '1':
                t='0'
                while True:
                    try:
                        if t=='0':
                            input_file_path = input("请输入文件路径：")
                        run_file(input_file_path)
                    except Exception as e:
                        # 获取详细的错误信息
                        error_info = traceback.format_exc()
                        logger.error(f"运行文件时发生错误：{error_info}")
                        # 读取Settings.json
                        Settigs = get_settings()
                        if Settigs['on_error_restart']==True:
                            logger.info('程序错误，正在重启，可前往配置编辑器配置错误处理项')
                            time.sleep(Settigs['on_err_restart_time'])
                            t='1'
                        else:
                            break
                        
            elif input_file_path == '2':
                try:
                    win32api.ShellExecute(0, 'open', 'pluginInstallTool.exe', '', '', 1)
                except Exception as e:
                    logger.error(f"打开插件安装工具时发生错误：{e}")
                # p=requests.get('https://124.221.67.43/plugin.json').json()
                # for i in range(len(p['list'])):
                #     print(i+1,'：',p['list'][i])
                # print('请输入要查看的拓展编号')
                # if runType=='run':
                #     input_code = input("")
                # else:
                #     input_code = '1'
                # if int(input_code)>len(p['list']):
                #     print('输入错误')
                # else:
                #     print('拓展信息：')
                #     print('名称：',p['list'][int(input_code)-1])
                #     print('版本：',p['version'][int(input_code)-1])
                #     if p['file'][int(input_code)-1]['type']=='exe':
                #         print('类型：单文件可执行程序(exe)')
                #     elif p['file'][int(input_code)-1]['type']=='py':
                #         print('类型：python脚本')
                #     else:
                #         print('未知类型：',p['file'][int(input_code)-1]['type'])
                #     print('作者：',p['author'][int(input_code)-1])
                #     print('简介：',p['info'][int(input_code)-1])
                #     id=int(input_code)-1
                #     print('')
                #     print('是否安装？(y/n)')
                #     if runType=='run':
                #         input_code = input("")
                #     else:
                #         input_code = 'y'
                #     if input_code == 'y':
                #         # 下载p['file'][id]['url']到plugin文件夹
                #         logger.info('开始下载')
                #         response = requests.get('https://124.221.67.43/'+p['file'][id]['url'], stream=True)
                #         url='https://124.221.67.43/'+p['file'][id]['url']
                #         file_name = 'plugin/'+url.split("/")[-1]
                #         response = requests.get(url, stream=True)
                #         file_size = int(response.headers.get("content-length", 0))
                #         chunk_size = 1024  # 每次下载的块大小
                #         start_time = time.time()
                #         downloaded = 0
                #         with open(file_name, "wb") as file, tqdm(
                #             desc=file_name,
                #             total=file_size,
                #             unit="B",
                #             unit_scale=True,
                #             unit_divisor=1024,
                #         ) as bar:
                #             for data in response.iter_content(chunk_size=chunk_size):
                #                 file.write(data)
                #                 downloaded += len(data)
                #                 bar.update(len(data))
                #                 elapsed_time = time.time() - start_time
                #                 download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                #                 bar.set_postfix()
                #         logger.info(f"下载完成：{file_name}")
                #         # 读取plugin.json,添加插件信息
                #         try:
                #             with open('plugin.json', 'r', encoding='utf-8') as f:
                #                 plugin = json.load(f)
                #         except:
                #             plugin={'list':[]}
                #         plugin['list'].append({'name': p['list'][id], 'version': p['version'][id], 'type': p['file'][id]['type'], 'author': p['author'][id], 'info': p['info'][id], 'url': p['file'][id]['url'].split('/')[-1],'id': id})
                #         with open('plugin.json', 'w', encoding='utf-8') as f:
                #             json.dump(plugin, f, ensure_ascii=False, indent=4)
                #         logger.info('安装完成')
                if runType=='run':
                    pass
                else:
                    exec("""
import fanbookbotapi
print(fanbookbotapi.getme('').text)
print(fanbookbotapi.sendmessage('').text)
print(fanbookbotapi.send_user_message(bot_token='').text)
""")
                    return 0
            elif input_file_path == '3':
                # 读取plugin.json,打印插件列表
                try:
                    with open('plugin.json', 'r', encoding='utf-8') as f:
                        plugin = json.load(f)
                except:
                    plugin={'List':[]}
                for i in range(len(plugin['List'])):
                    print(i+1,'：',plugin['List'][i]['Name'])
                if len(plugin['List'])==0:
                    print('没有安装任何插件')
                else:
                    print('请输入要使用的拓展编号')
                    input_code = input("")
                    if int(input_code)>len(plugin['List']):
                        print('输入错误')
                    else:
                        # 读取plugin.json,获取插件信息
                        try:
                            with open('plugin.json', 'r', encoding='utf-8') as f:
                                plugin = json.load(f)
                        except:
                            plugin={'List':[]}
                        # 运行插件
                        try:
                            if 'exe' in plugin['List'][int(input_code)-1]['File']['Type']:
                                win32api.ShellExecute(0, 'open', f'plugin\\{plugin["List"][int(input_code)-1]["File"]["Url"].split("/")[-1]}', '', '', 1)
                            elif 'py' in plugin['List'][int(input_code)-1]['File']['Type']:
                                run_file(f'plugin/{plugin["List"][int(input_code)-1]["File"]["Url"].split("/")[-1]}',type='plugin')
                            else:
                                logger.error(f"不支持的文件类型：{plugin['List'][int(input_code)-1]['File']['Type']}")
                        except Exception as e:
                            # 获取详细的错误信息
                            error_info = traceback.format_exc()
                            logger.error(f"运行文件时发生错误：{error_info}")
            elif input_file_path == '4':
                # 删除插件
                try:
                    with open('plugin.json', 'r', encoding='utf-8') as f:
                        plugin = json.load(f)
                except:
                    plugin={'List':[]}
                for i in range(len(plugin['List'])):
                    print(i+1,'：',plugin['List'][i]['Name'])
                if len(plugin['List'])==0:
                    print('没有安装任何插件')
                else:
                    print('请输入要删除的拓展编号')
                    input_code = input("")
                    if int(input_code)>len(plugin['List']):
                        print('输入错误')
                    else:
                        # 读取plugin.json,获取插件信息
                        try:
                            with open('plugin.json', 'r', encoding='utf-8') as f:
                                plugin = json.load(f)
                        except:
                            plugin={'List':[]}
                        # 删除插件
                        try:
                            os.remove(f'plugin/{plugin["List"][int(input_code)-1]["File"]["Url"].split("/")[-1]}')
                            plugin['List'].pop(int(input_code)-1)
                            with open('plugin.json', 'w', encoding='utf-8') as f:
                                json.dump(plugin, f, ensure_ascii=False, indent=4)
                            logger.info('插件删除完成')
                        except Exception as e:
                            # 获取详细的错误信息
                            error_info = traceback.format_exc()
                            logger.error(f"删除文件时发生错误：{error_info}")
            elif input_file_path == 'F':
                try:
                    win32api.ShellExecute(0, 'open', 'ErrorUpload.exe', '', '', 1)
                    time.sleep(3)
                except:
                    pass
            elif input_file_path == 'S':
                win32api.ShellExecute(0, 'open', 'Settings.exe', '', '', 1)
                print('提示：修改配置实时生效，无需重启程序')
                time.sleep(0.1)
            elif input_file_path == '0':
                break
    except:
        # 获取详细的错误信息
        error_info = traceback.format_exc()
        logger.critical(f"发生错误：{error_info}")
        # 写入错误日志
        try:
            with open('error.log', 'a', encoding='utf-8') as f:
                f.write(error_info)
            win32api.ShellExecute(0, 'open', 'ErrorUpload.exe', '', '', 1)
            time.sleep(5)
        except:
            pass
if __name__ == '__main__':
    main(runType='run')

def _test():
    return main(runType='test')