print("""⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⢀⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⣿⠛⠛⠃⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⠄⠄⠄⠄⠄⠄⠄⡟⠛⠛⣦⠄⢀⡴⠛⠛⠛⢦⡀⠘⠛⣿⠛⠛⠄⠄⠄⠤⢼⠤⢸⢉⣉⣉⣉⡁⠒⢺⠓⢲⠂⡟⠉⢹⠄⠄⠄
⠄⠄⣿⣤⣤⠄⠐⠉⠉⢳⠄⢸⡗⠉⠙⡆⠄⣿⠎⠉⢳⡆⠄⡖⠉⠉⢶⡄⢠⠞⠉⠉⣶⠄⢸⢀⡴⠋⠄⠄⠄⠄⣷⣤⣶⡃⠄⣾⡇⠄⠄⠄⠈⡇⠄⠄⣿⠄⠄⠄⠄⠄⢀⣾⢦⣸⢀⣀⣯⣀⠄⣠⠎⠤⠾⠄⠗⠒⠺⠄⠄⠄
⠄⠄⣿⠄⠄⠄⢸⠋⠉⣸⠄⢸⡇⠄⠄⡇⠄⣿⡀⠄⣠⡇⠄⣇⠄⠄⣸⠇⠸⣀⠄⠄⡿⠄⢸⠙⢧⡀⠄⠄⠄⠄⡇⠄⠄⣸⠄⠹⣇⡀⠄⢀⣰⠃⠄⠄⣿⠄⠄⠄⠄⠄⠟⢸⠄⢸⠄⠄⠇⠄⠄⠒⠒⠒⡶⡷⢖⠒⠒⠒⠄⠄
⠄⠄⠛⠄⠄⠄⠘⠛⠋⠘⠄⠘⠃⠄⠄⠃⠄⠛⠙⠚⠋⠄⠄⠉⠛⠛⠁⠄⠄⠙⠓⠛⠁⠄⠘⠄⠈⠛⠄⠄⠄⠄⠛⠛⠛⠁⠄⠄⠈⠛⠛⠋⠁⠄⠄⠄⠛⠄⠄⠄⠄⠄⠄⢸⠄⠸⠤⠤⠤⠤⠤⠤⠔⠋⠄⡇⠄⠛⠢⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⡆⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠰⠶⠶⢶⡶⠶⠶⠶⠄⠄⠄⠄⢸⡇⠄⠄⠄⠄⠒⠒⠒⠒⠒⠒⢲⠒⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⣇⠴⠶⣤⡀⢶⠄⠄⣰⠂⠄⠰⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢸⡇⠄⠄⠄⠄⠒⠒⠒⢺⡗⠒⠒⠒⠄⠄⠧⠤⠤⠼⠄⠸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⡇⠄⠄⢸⡇⠈⣆⢰⠏⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠉⠉⢹⡏⠉⠉⠁⠄⠄⠄⢀⡎⠹⡀⠄⠄⠄⢉⣉⣉⣉⣉⠉⢹⠉⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠟⠳⠶⠋⠄⠄⢸⡏⠄⠄⠄⠸⠄⠄⠄⠄⠄⠄⠄⣀⣀⣀⣸⣇⣀⣀⣀⠄⣀⠴⠋⠄⠄⠙⠧⣄⠄⠸⠷⠶⠶⠾⣀⣸⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠤⠛⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠉⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄""")
import logging
import coloredlogs
# 创建日志记录器
logger = logging.getLogger(__name__)
# 配置 coloredlogs
coloredlogs.install(level='DEBUG', logger=logger)
_v=1.3
    
logger.info('版本号：'+str(_v))
logger.info("开始初始化")
from fanbookbotapi import *
import json
import requests
import os
import subprocess
import traceback
import sentry_sdk
import time
import sys
try:
    import win32api
except:
    pass    
from tqdm import tqdm

def main(runType='run'):
    try:
        sentry_sdk.init(
            dsn="https://b276d223ebdc092ad9d655d09403355d@o4507525750521856.ingest.us.sentry.io/4507924708982784",
            # Set traces_sample_rate to 1.0 to capture 100%
            # of transactions for tracing.
            traces_sample_rate=1.0,
            # Set profiles_sample_rate to 1.0 to profile 100%
            # of sampled transactions.
            # We recommend adjusting this value in production.
            profiles_sample_rate=1.0,
        )
            
        logger.info('正在获取配置信息')
        try:
            appmsg=requests.get('https://124.221.67.43/hj_data.json')
            appmsg=appmsg.json()
        except:
            logger.warning('网络错误')
            
        logger.info('正在检查更新')
        try:
            #读取file_v.json
            try:
                with open('file_v.json', 'r', encoding='utf-8') as f:
                    file_v = json.load(f)
            except:
                file_v={'appmessage':0,'update':0,'ErrorUpload':0,'硬件检测引擎':0}
            if appmsg['appmessage']>file_v['appmessage']:
                logger.info('发现新版本组件')
                url='https://124.221.67.43/appMessage.exe'
                file_name = url.split("/")[-1]
                response = requests.get(url, stream=True)
                file_size = int(response.headers.get("content-length", 0))
                chunk_size = 1024  # 每次下载的块大小
                start_time = time.time()
                downloaded = 0
                with open(file_name, "wb") as file, tqdm(
                    desc=file_name,
                    total=file_size,
                    unit="B",
                    unit_scale=True,
                    unit_divisor=1024,
                ) as bar:
                    for data in response.iter_content(chunk_size=chunk_size):
                        file.write(data)
                        downloaded += len(data)
                        bar.update(len(data))
                        elapsed_time = time.time() - start_time
                        download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                        bar.set_postfix()
            if appmsg['update']>file_v['update']:
                logger.info('发现新版本组件')
                url='https://124.221.67.43/hj_update.exe'
                file_name = url.split("/")[-1]
                response = requests.get(url, stream=True)
                file_size = int(response.headers.get("content-length", 0))
                chunk_size = 1024  # 每次下载的块大小
                start_time = time.time()
                downloaded = 0
                with open(file_name, "wb") as file, tqdm(
                    desc=file_name,
                    total=file_size,
                    unit="B",
                    unit_scale=True,
                    unit_divisor=1024,
                ) as bar:
                    for data in response.iter_content(chunk_size=chunk_size):
                        file.write(data)
                        downloaded += len(data)
                        bar.update(len(data))
                        elapsed_time = time.time() - start_time
                        download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                        bar.set_postfix()
                if appmsg['ErrorUpload']>file_v['ErrorUpload']:
                    logger.info('发现新版本组件')
                    url='https://124.221.67.43/ErrorUpload.exe'
                    file_name = url.split("/")[-1]
                    response = requests.get(url, stream=True)
                    file_size = int(response.headers.get("content-length", 0))
                    chunk_size = 1024  # 每次下载的块大小
                    start_time = time.time()
                    downloaded = 0
                    with open(file_name, "wb") as file, tqdm(
                        desc=file_name,
                        total=file_size,
                        unit="B",
                        unit_scale=True,
                        unit_divisor=1024,
                    ) as bar:
                        for data in response.iter_content(chunk_size=chunk_size):
                            file.write(data)
                            downloaded += len(data)
                            bar.update(len(data))
                            elapsed_time = time.time() - start_time
                            download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                            bar.set_postfix()
                if appmsg['硬件检测引擎']>file_v['硬件检测引擎']:
                    logger.info('发现新版本组件')
                    url='https://124.221.67.43/硬件检测引擎.dll'
                    file_name = url.split("/")[-1]
                    response = requests.get(url, stream=True)
                    file_size = int(response.headers.get("content-length", 0))
                    chunk_size = 1024  # 每次下载的块大小
                    start_time = time.time()
                    downloaded = 0
                    with open(file_name, "wb") as file, tqdm(
                        desc=file_name,
                        total=file_size,
                        unit="B",
                        unit_scale=True,
                        unit_divisor=1024,
                    ) as bar:
                        for data in response.iter_content(chunk_size=chunk_size):
                            file.write(data)
                            downloaded += len(data)
                            bar.update(len(data))
                            elapsed_time = time.time() - start_time
                            download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                            bar.set_postfix()
                logger.info('更新完成')
                #更改file_v.json appmessage版本号
            file_v['appmessage']=appmsg['appmessage']
            file_v['update']=appmsg['update']
            file_v['ErrorUpload']=appmsg['ErrorUpload']
            file_v['硬件检测引擎']=appmsg['硬件检测引擎']
            with open('file_v.json', 'w', encoding='utf-8') as f:
                json.dump(file_v, f, ensure_ascii=False, indent=4)

        except:
            logger.warning('更新错误')

        try:
            if appmsg['open']==True:
                subprocess.Popen(['appMessage.exe'])
        except:
            pass

        if _v<appmsg['main']:
            logger.info('发现新版本主程序')
            try:
                os.system('taskkill /f /im appMessage.exe')
                win32api.ShellExecute(0, 'open', 'hj_update.exe', '', '', 1)
                sys.exit()
            except:
                logger.warning('更新错误')

        logger.info('初始化完成')

        #用户输入代码文件路径，然后全局运行该文件
        def run_file(file_path):
            #如果路径被双引号包围，则去掉双引号
            if file_path.startswith('"') and file_path.endswith('"'):
                file_path = file_path[1:-1]
            with open(file_path, 'r', encoding='utf-8') as f:
                code = f.read()
            if 'main.py' in file_path:
                logger.warning('程序目录下的main.py在每次更新后会被覆盖，请将代码保存到其他文件中')
            logger.info(f"正在运行文件：{file_path}")
            exec(code)
            logger.info(f"文件运行完成：{file_path}")

        while True:
            print("""1：运行文件
2：安装拓展
3：使用拓展
4：卸载拓展
F：发送反馈
                """)
            if runType=='run':
                input_file_path = input("请输入功能编号：")
            else:
                input_file_path = '2'
            if input_file_path == '1':
                try:
                    input_file_path = input("请输入文件路径：")
                    run_file(input_file_path)
                except Exception as e:
                    #获取详细的错误信息
                    error_info = traceback.format_exc()
                    logger.error(f"运行文件时发生错误：{error_info}")
            elif input_file_path == '2':
                p=requests.get('https://124.221.67.43/plugin.json').json()
                for i in range(len(p['list'])):
                    print(i+1,'：',p['list'][i])
                print('请输入要查看的拓展编号')
                if runType=='run':
                    input_code = input("")
                else:
                    input_code = '1'
                if int(input_code)>len(p['list']):
                    print('输入错误')
                else:
                    print('拓展信息：')
                    print('名称：',p['list'][int(input_code)-1])
                    print('版本：',p['version'][int(input_code)-1])
                    if p['file'][int(input_code)-1]['type']=='exe':
                        print('类型：单文件可执行程序(exe)')
                    elif p['file'][int(input_code)-1]['type']=='py':
                        print('类型：python脚本')
                    else:
                        print('未知类型：',p['file'][int(input_code)-1]['type'])
                    print('作者：',p['author'][int(input_code)-1])
                    print('简介：',p['info'][int(input_code)-1])
                    id=int(input_code)-1
                    print('')
                    print('是否安装？(y/n)')
                    if runType=='run':
                        input_code = input("")
                    else:
                        input_code = 'y'
                    if input_code == 'y':
                        #下载p['file'][id]['url']到plugin文件夹
                        logger.info('开始下载')
                        response = requests.get('https://124.221.67.43/'+p['file'][id]['url'], stream=True)
                        url='https://124.221.67.43/'+p['file'][id]['url']
                        file_name = 'plugin/'+url.split("/")[-1]
                        response = requests.get(url, stream=True)
                        file_size = int(response.headers.get("content-length", 0))
                        chunk_size = 1024  # 每次下载的块大小
                        start_time = time.time()
                        downloaded = 0
                        with open(file_name, "wb") as file, tqdm(
                            desc=file_name,
                            total=file_size,
                            unit="B",
                            unit_scale=True,
                            unit_divisor=1024,
                        ) as bar:
                            for data in response.iter_content(chunk_size=chunk_size):
                                file.write(data)
                                downloaded += len(data)
                                bar.update(len(data))
                                elapsed_time = time.time() - start_time
                                download_speed = downloaded / elapsed_time  # 下载速度，单位为B/s
                                bar.set_postfix()
                        logger.info(f"下载完成：{file_name}")
                        #读取plugin.json,添加插件信息
                        try:
                            with open('plugin.json', 'r', encoding='utf-8') as f:
                                plugin = json.load(f)
                        except:
                            plugin={'list':[]}
                        plugin['list'].append({'name': p['list'][id], 'version': p['version'][id], 'type': p['file'][id]['type'], 'author': p['author'][id], 'info': p['info'][id], 'url': p['file'][id]['url'].split('/')[-1],'id': id})
                        with open('plugin.json', 'w', encoding='utf-8') as f:
                            json.dump(plugin, f, ensure_ascii=False, indent=4)
                        logger.info('安装完成')
                        if runType=='run':
                            pass
                        else:
                            exec("""
import fanbookbotapi
print(fanbookbotapi.getme('').text)
print(fanbookbotapi.sendmessage('').text)
print(fanbookbotapi.send_user_message(bot_token='').text)
                                 """)
                            break
            elif input_file_path == '3':
                #读取plugin.json,打印插件列表
                try:
                    with open('plugin.json', 'r', encoding='utf-8') as f:
                        plugin = json.load(f)
                    #删除重复的插件
                    plugin['list'] = list({v['id']:v for v in plugin['list']}.values())
                except:
                    plugin={'list':[]}
                for i in range(len(plugin['list'])):
                    print(i+1,'：',plugin['list'][i]['name'])
                if len(plugin['list'])==0:
                    print('没有安装任何插件')
                else:
                    print('请输入要使用的拓展编号')
                    input_code = input("")
                    if int(input_code)>len(plugin['list']):
                        print('输入错误')
                    else:
                        #读取plugin.json,获取插件信息
                        try:
                            with open('plugin.json', 'r', encoding='utf-8') as f:
                                plugin = json.load(f)
                        except:
                            plugin={'list':[]}
                        #运行插件
                        try:
                            if plugin['list'][int(input_code)-1]['type']=='exe':
                                os.startfile(f'plugin/{plugin["list"][int(input_code)-1]["url"]}')
                            elif plugin['list'][int(input_code)-1]['type']=='py':
                                run_file(f'plugin/{plugin["list"][int(input_code)-1]["url"]}')
                        except Exception as e:
                            #获取详细的错误信息
                            error_info = traceback.format_exc()
                            logger.error(f"运行文件时发生错误：{error_info}")
            elif input_file_path == '4':
                #删除插件
                try:
                    with open('plugin.json', 'r', encoding='utf-8') as f:
                        plugin = json.load(f)
                    #删除重复的插件
                    plugin['list'] = list({v['id']:v for v in plugin['list']}.values())
                except:
                    plugin={'list':[]}
                for i in range(len(plugin['list'])):
                    print(i+1,'：',plugin['list'][i]['name'])
                if len(plugin['list'])==0:
                    print('没有安装任何插件')
                else:
                    print('请输入要删除的拓展编号')
                    input_code = input("")
                    if int(input_code)>len(plugin['list']):
                        print('输入错误')
                    else:
                        #读取plugin.json,获取插件信息
                        try:
                            with open('plugin.json', 'r', encoding='utf-8') as f:
                                plugin = json.load(f)
                        except:
                            plugin={'list':[]}
                        #删除插件
                        try:
                            plugin['list'].pop(int(input_code)-1)
                            with open('plugin.json', 'w', encoding='utf-8') as f:
                                json.dump(plugin, f, ensure_ascii=False, indent=4)
                            os.remove(f'plugin/{plugin["list"][int(input_code)-1]["url"]}')
                            logger.info('删除完成')
                        except Exception as e:
                            #获取详细的错误信息
                            error_info = traceback.format_exc()
                            logger.error(f"删除文件时发生错误：{error_info}")
            elif input_file_path == 'F':
                try:
                    win32api.ShellExecute(0, 'open', 'ErrorUpload.exe', '', '', 1)
                    time.sleep(3)
                except:
                    pass
    except:
        #获取详细的错误信息
        error_info = traceback.format_exc()
        logger.critical(f"发生错误：{error_info}")
        #写入错误日志
        try:
            with open('error.log', 'a', encoding='utf-8') as f:
                f.write(error_info)
            win32api.ShellExecute(0, 'open', 'ErrorUpload.exe', '', '', 1)
            time.sleep(5)
        except:
            pass
if __name__ == '__main__':
    main(runType='run')
else:
    main(runType='test')